"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs_extra_1 = __importDefault(require("fs-extra"));
const pkg_up_1 = __importDefault(require("pkg-up"));
const path_1 = __importDefault(require("path"));
const semver_1 = __importDefault(require("semver"));
const __1 = require("../");
const constants_1 = require("./constants");
const frameworks_1 = require("./frameworks");
const utils_1 = require("./utils");
const log = __1._log('Initializer');
const promptWithDefault = async (message, examples, def, yes) => {
    // console.log({message, examples, def, yes})
    log(message);
    if (yes) {
        if (def) {
            log(`  -y set, using ğŸ’›${def}ğŸ’›\n`);
            return def;
        }
        throw new __1.FabInitError('-y specified but no default found!');
    }
    return await (def ? __1.prompt('> ', { default: def }) : __1.prompt(examples));
};
class Initializer {
    static async init(config_filename, yes, skip_install, version, skip_framework_detection, empty) {
        this.yes = yes || empty;
        log.announce(`fab init â€” ${this.description}`);
        /* First, figure out the nearest package.json */
        const package_json_path = await pkg_up_1.default();
        if (!package_json_path) {
            throw new __1.FabInitError(`Cannot find a package.json in this or any parent directory`);
        }
        const root_dir = path_1.default.dirname(package_json_path);
        if (root_dir !== process.cwd()) {
            if (this.yes) {
                throw new __1.FabInitError(`Note: fab init -y must be run from the root of your project (where your package.json lives) since it will automatically change files.`);
            }
            else {
                log(`â¤ï¸Warning:â¤ï¸ There's no package.json in this directory, the nearest is at ğŸ’š${path_1.default.relative(process.cwd(), package_json_path)}ğŸ’š`);
                const confirmed = await log.confirmAndRespond(`ğŸ’›Are you sure you want to configure a FAB here?ğŸ’›`);
                if (!confirmed)
                    return;
            }
        }
        /* Then, figure out what kind of project we are */
        const package_json = await this.getPackageJson(package_json_path);
        const use_yarn = await __1.useYarn(root_dir);
        const additional_dependencies = [];
        if (empty) {
            /* Generate/update the FAB config file */
            await this.updateConfig(root_dir, config_filename, {}, true);
        }
        else {
            const framework = await this.getFramework(package_json, root_dir, skip_framework_detection);
            if (!framework)
                return;
            if (this.yes) {
                log.info(`Proceeding...`);
            }
            else {
                log(`ğŸ’šReady to proceed.ğŸ’š This process will:
        â€¢ Generate a ğŸ’›fab.config.json5ğŸ’› file for your project
        â€¢ Add ğŸ’›build:fabğŸ’› and related scripts to your ğŸ’›package.jsonğŸ’›
        â€¢ Add ğŸ’›.fabğŸ’› and ğŸ’›fab.zipğŸ’› to your ğŸ’›.gitignoreğŸ’›
        â€¢ Install ğŸ’›@fab/cliğŸ’› and related dependencies using ğŸ’›${use_yarn ? 'yarn' : 'npm'}ğŸ’›`);
                const confirmed = await log.confirmAndRespond(`Good to go? [y/N]`);
                if (!confirmed)
                    return;
            }
            /* Next, generate/update the FAB config file */
            await this.updateConfig(root_dir, config_filename, framework.plugins);
            /* Then, update the package.json to add a build:fab script */
            await this.addBuildFabScript(package_json_path, package_json, framework);
            /* Add any framework-specific config required */
            if (framework.customConfig)
                await framework.customConfig(root_dir);
            additional_dependencies.push(...Object.keys(framework.plugins));
        }
        /* Update the .gitignore file (if it exists) to add .fab and fab.zip */
        await this.addGitIgnores(root_dir);
        /* Finally, install the dependencies */
        if (!skip_install) {
            await this.installDependencies(root_dir, version, use_yarn, additional_dependencies);
        }
        await this.finalChecks(root_dir, package_json);
        log(`ğŸ’ All good ğŸ’`);
    }
    static async getFramework(package_json, root_dir, skip_framework_detection) {
        const framework = skip_framework_detection
            ? null
            : await this.determineProjectType(package_json);
        if (framework) {
            log(`ğŸ’šSuccess!ğŸ’š Found a ğŸ’›${framework.name}ğŸ’› project. We know exactly how to configure this ğŸ‘`);
            return framework;
        }
        else {
            if (skip_framework_detection) {
                log(`â¤ï¸Skipping framework detection.â¤ï¸`);
            }
            else {
                log(`â¤ï¸Warning: Could not find a known framework to auto-generate config.â¤ï¸
        Currently supported frameworks for auto-detection are:
        â€¢ ğŸ’›${frameworks_1.FRAMEWORK_NAMES.join('\nâ€¢ ')}ğŸ’›

        If your project uses one of these but wasn't detected, please raise an issue: https://github.com/fab-spec/fab/issues.
      `);
            }
            log(`
        ğŸ’šNOTE: if your site is statically-rendered (e.g. JAMstack) we can still set things up.ğŸ’š
        Check https://fab.dev/kb/static-sites for more info.

        We'll need your:
        â€¢ Build command (usually ğŸ’›npm run buildğŸ’›)
        â€¢ Output directory (usually ${constants_1.OUTPUT_DIR_EXAMPLES})
      `);
            const attempt_static = this.yes || (await log.confirmAndRespond(`Would you like to proceed?`));
            if (!attempt_static)
                return;
            return await this.setupStaticFramework(package_json, root_dir);
        }
    }
    static async setupStaticFramework(package_json, root_dir) {
        var _a;
        const npm_build_exists = !!((_a = package_json.scripts) === null || _a === void 0 ? void 0 : _a.build);
        const npm_run_build = `npm run build`;
        const build_cmd = await promptWithDefault(`What command do you use to build your project?`, `(usually something like "npm run xyz")`, npm_build_exists && npm_run_build, this.yes);
        // console.log({ build_cmd })
        let found_output_dir;
        for (const dir of constants_1.GUESSED_OUTPUT_DIRS) {
            const joined_path = path_1.default.join(root_dir, dir);
            if (await fs_extra_1.default.pathExists(joined_path)) {
                found_output_dir = dir;
                break;
            }
        }
        const output_dir = await promptWithDefault(`Where is your project built into?`, `(e.g. ${constants_1.OUTPUT_DIR_EXAMPLES})`, found_output_dir, this.yes);
        return frameworks_1.GenericStatic(build_cmd, output_dir);
    }
    static async getPackageJson(package_json_path) {
        try {
            return JSON.parse(await fs_extra_1.default.readFile(package_json_path, 'utf8'));
        }
        catch (e) {
            throw new __1.FabInitError(`Something went wrong parsing ${package_json_path}!`);
        }
    }
    static async determineProjectType(package_json) {
        log(`Searching for a ğŸ’›known project typeğŸ’›...
    ğŸ–¤If your project is not correctly detected,ğŸ–¤
    ğŸ–¤or if the generated config is incorrect,ğŸ–¤
    ğŸ–¤please leave some feedback atğŸ–¤ ğŸ’›https://fab.dev/guides/known-project-typesğŸ’›`);
        return ((await this.isNext9(package_json)) ||
            (await this.isCreateReactApp(package_json)) ||
            (await this.isGatsby(package_json)) ||
            null);
    }
    static async isNext9(package_json) {
        var _a, _b, _c, _d, _e, _f, _g, _h;
        const nextjs_version = ((_a = package_json.dependencies) === null || _a === void 0 ? void 0 : _a['next']) || ((_b = package_json.devDependencies) === null || _b === void 0 ? void 0 : _b['next']);
        if (!nextjs_version)
            return false;
        const next_build = (_d = (_c = package_json.scripts) === null || _c === void 0 ? void 0 : _c.build) === null || _d === void 0 ? void 0 : _d.match(/next build/);
        const next_build_export = (_f = (_e = package_json.scripts) === null || _e === void 0 ? void 0 : _e.build) === null || _f === void 0 ? void 0 : _f.match(/next export/);
        const next_export = (_h = (_g = package_json.scripts) === null || _g === void 0 ? void 0 : _g.export) === null || _h === void 0 ? void 0 : _h.match(/next export/);
        const activeNextProject = (await fs_extra_1.default.pathExists('.next')) || next_build || next_build_export || next_export;
        if (!activeNextProject) {
            throw new __1.FabInitError(`Detected NextJS as a dependency but no .next directory found & npm run build doesn't contain 'next build'!`);
        }
        if (semver_1.default.valid(nextjs_version) &&
            semver_1.default.lt(semver_1.default.coerce(nextjs_version), '9.0.0')) {
            throw new __1.FabInitError(`Detected a NextJS project but using an older version (${nextjs_version}). FABs currently only support NextJS v9 or later.`);
        }
        if (next_build_export) {
            return frameworks_1.Frameworks.Next9({ export_build: true, build_cmd: 'npm run build' });
        }
        else if (next_export) {
            if (!next_build) {
                return frameworks_1.Frameworks.Next9({ export_build: true, build_cmd: 'npm run export' });
            }
            log(`You have both ğŸ’›next buildğŸ’› and ğŸ’›next exportğŸ’› in your npm scripts.
        What command do you use to build your project?
        â€¢ for dynamic (serverless) sites, this is ğŸ’›npm run buildğŸ’›,
        â€¢ or for static sites this is ğŸ’›npm run exportğŸ’›
      `);
            const build_cmd = await promptWithDefault(`Your build command`, ``, 'npm run export', this.yes);
            const export_build = this.yes || build_cmd === 'npm run export'
                ? true
                : await log.confirmAndRespond(`Is this a static (i.e. ğŸ’›next exportğŸ’›) site?`);
            return frameworks_1.Frameworks.Next9({ export_build, build_cmd });
        }
        else {
            return frameworks_1.Frameworks.Next9({ export_build: false, build_cmd: 'npm run build' });
        }
    }
    static async isCreateReactApp(package_json) {
        var _a, _b;
        const react_scripts_version = ((_a = package_json.dependencies) === null || _a === void 0 ? void 0 : _a['react-scripts']) || ((_b = package_json.devDependencies) === null || _b === void 0 ? void 0 : _b['react-scripts']);
        if (!react_scripts_version)
            return false;
        if (semver_1.default.valid(react_scripts_version) &&
            semver_1.default.lt(semver_1.default.coerce(react_scripts_version), '2.0.0')) {
            throw new __1.FabInitError(`Detected a Create React App project but using an older version of react-scripts (${react_scripts_version}). FABs only support v2+.`);
        }
        return frameworks_1.Frameworks.CreateReactApp();
    }
    static async isGatsby(package_json) {
        var _a, _b, _c, _d;
        const gatsby_dep = ((_a = package_json.dependencies) === null || _a === void 0 ? void 0 : _a['gatsby']) || ((_b = package_json.devDependencies) === null || _b === void 0 ? void 0 : _b['gatsby']);
        if (!gatsby_dep)
            return false;
        if (!((_d = (_c = package_json.scripts) === null || _c === void 0 ? void 0 : _c.build) === null || _d === void 0 ? void 0 : _d.match(/gatsby build/))) {
            throw new __1.FabInitError(`Detected Gatsby as a dependency but npm run build doesn't contain 'gatsby build'`);
        }
        return frameworks_1.Frameworks.Gatsby();
    }
    static async installDependencies(root_dir, version, use_yarn, plugin_deps) {
        const versioned = (deps) => deps.map((dep) => (version ? `${dep}@${version}` : dep));
        const core_deps = versioned(constants_1.DEFAULT_DEPS);
        const framework_deps = versioned(plugin_deps);
        log.note(`Installing required ğŸ’›FAB coreğŸ’› dependencies:
      ${core_deps.map((d) => `â€¢ ${d}`).join('\n  ')}`);
        log(`and the following ğŸ’›project-specificğŸ’› plugins:
      ${framework_deps.map((d) => `â€¢ ${d}`).join('\n  ')}`);
        log(`using ğŸ’›${use_yarn ? 'yarn' : 'npm'}...ğŸ’›`);
        await __1.installDependencies(use_yarn, [...core_deps, ...framework_deps], root_dir);
        log(`ğŸ’šDone!ğŸ’š`);
        log(`Now run ğŸ’›${use_yarn ? 'yarn' : 'npm run'} build:fabğŸ’› to build your project and generate a FAB from it!
      or visit ğŸ’›https://fab.dev/guides/getting-startedğŸ’› for more info.`);
    }
    static async updateConfig(root_dir, config_filename, plugins, auto_skip_if_exists = false) {
        const config_path = path_1.default.resolve(root_dir, config_filename);
        const config = await this.readExistingConfig(config_path);
        if (Object.keys(config.data.plugins).length > 0) {
            if (auto_skip_if_exists)
                return;
            log.warn(`Existing config has a "plugins" section.`);
            const confirmed = (this.yes && log(`Overwriting since -y is set.`)) ||
                (await log.confirmAndRespond(`Would you like to overwrite it?`, `Ok, overwriting...`, `Ok, leaving as-is.`));
            if (!confirmed)
                return;
        }
        config.data.plugins = plugins;
        await config.write(config_filename);
    }
    static async readExistingConfig(config_path) {
        if (await fs_extra_1.default.pathExists(config_path)) {
            return await __1.JSON5Config.readFrom(config_path);
        }
        else {
            return __1.JSON5Config.generate(constants_1.BASE_CONFIG);
        }
    }
    static async addBuildFabScript(package_json_path, package_json, framework) {
        var _a;
        if (!this.yes && ((_a = package_json.scripts) === null || _a === void 0 ? void 0 : _a['build:fab'])) {
            log.info(`Already detected a build:fab command.`);
            log(`We want to add/overwrite the following lines to your ğŸ’›package.jsonğŸ’›:
        ğŸ’›${JSON.stringify(framework.scripts, null, 2)}ğŸ’›
      `);
            const ok = await log.confirmAndRespond(`Overwrite existing scripts?`);
            if (!ok)
                return;
        }
        await fs_extra_1.default.writeFile(package_json_path, JSON.stringify({
            ...package_json,
            scripts: utils_1.mergeScriptsAfterBuild(package_json.scripts, framework.scripts),
        }, null, 2));
    }
    static async addGitIgnores(root_dir) {
        const gitignore_path = path_1.default.join(root_dir, '.gitignore');
        if (await fs_extra_1.default.pathExists(gitignore_path)) {
            const gitignore = await fs_extra_1.default.readFile(gitignore_path, 'utf8');
            const ignore_lines = gitignore.split('\n').map((line) => line.trim());
            const lines_set = new Set(ignore_lines);
            const lines_to_add = constants_1.GITIGNORE_LINES.filter((line) => !lines_set.has(line) && !lines_set.has(line.slice(1)));
            if (lines_to_add.length > 0) {
                await fs_extra_1.default.writeFile(gitignore_path, [...ignore_lines, ...lines_to_add].join('\n') + '\n');
            }
        }
    }
    /* Make sure the repo is OK */
    static async finalChecks(root_dir, package_json) {
        const deprecated = constants_1.DEPRECATED_PACKAGES;
        const deps = new Set([
            ...Object.keys(package_json.dependencies || {}),
            ...Object.keys(package_json.devDependencies || {}),
        ]);
        const warn_about = deprecated.filter((dep) => deps.has(dep));
        if (warn_about.length > 0) {
            log(`â¤ï¸WARNING:â¤ï¸ you have deprecated FAB dependencies in your package.json: ğŸ’›${warn_about.join(', ')}ğŸ’›`);
        }
        const old_prod_settings_file = 'production-settings.json';
        if (await fs_extra_1.default.pathExists(path_1.default.join(root_dir, old_prod_settings_file))) {
            log(`â¤ï¸WARNING:â¤ï¸ you have a ğŸ’›${old_prod_settings_file}ğŸ’› file in this directory.\nSettings are now part of ğŸ’›fab.config.json5ğŸ’›, read more at ğŸ–¤https://fab.dev/kb/settingsğŸ–¤.`);
        }
    }
}
exports.default = Initializer;
Initializer.description = `Auto-configure a repo for generating FABs`;
//# sourceMappingURL=index.js.map